---
import { getCollection } from "astro:content";
import type { ChallengeEntry } from "@/lib/types";

import BaseLayout from "@/layouts/BaseLayout.astro";
import { ChallengeList } from "@/components/challenge/ChallengeList";
import { Badge } from "@/components/ui/badge";

const challengeEntries: ChallengeEntry[] = await getCollection("challenges");

// Transform challenges into the format expected by the React component
const challenges = challengeEntries.map((entry) => ({
    id: entry.id,
    title: entry.data.title,
    summary: entry.data.summary,
    level: entry.data.level,
    duration_hours: entry.data.duration_hours,
    providers: entry.data.providers,
    services: entry.data.services,
    tags: entry.data.tags,
    created_at: entry.data.created_at?.toISOString(),
}));

// Extract unique filter values
const allProviders = [
    ...new Set(challengeEntries.flatMap((c) => c.data.providers)),
].sort();
const allServices = [
    ...new Set(challengeEntries.flatMap((c) => c.data.services)),
].sort();
const allTags = [
    ...new Set(challengeEntries.flatMap((c) => c.data.tags)),
].sort();
const allLevels = [
    ...new Set(challengeEntries.map((c) => c.data.level).filter(Boolean)),
] as string[];

// Sort levels by difficulty order
const levelOrder = ["beginner", "easy", "intermediate", "advanced", "expert"];
allLevels.sort((a, b) => levelOrder.indexOf(a) - levelOrder.indexOf(b));
---

<BaseLayout>
    <section class="space-y-8">
        <!-- Header section with inspiration from FeaturedChallenge -->
        <div
            class="relative overflow-hidden rounded-xl border bg-card p-8 shadow-sm md:p-10"
        >
            <!-- Decorative background pattern -->
            <div
                class="absolute inset-0 bg-[linear-gradient(45deg,transparent_48%,var(--border)_49%,var(--border)_51%,transparent_52%)] bg-size-[8px_8px] opacity-20"
                aria-hidden="true"
            >
            </div>

            <div class="relative">
                <Badge
                    variant="secondary"
                    className="mb-4 w-fit rounded-full px-3 py-1 text-[0.6rem] font-semibold uppercase tracking-[0.35em]"
                >
                    Challenges
                </Badge>
                <h1
                    class="mb-3 text-3xl font-bold tracking-tight text-foreground md:text-4xl"
                >
                    Cloud Challenges
                </h1>
                <p
                    class="max-w-2xl text-base leading-relaxed text-muted-foreground md:text-lg"
                >
                    Browse real-world cloud engineering problems. Each challenge
                    includes a detailed problem statement, starter code, and
                    validation checklists â€” you own and deploy everything in
                    your own cloud account.
                </p>

                <!-- Quick stats -->
                <div
                    class="mt-6 flex flex-wrap items-center gap-6 text-sm text-muted-foreground"
                >
                    <div class="flex items-center gap-2">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            aria-hidden="true"
                        >
                            <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"
                            ></path>
                            <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"
                            ></path>
                        </svg>
                        <span
                            ><strong class="text-foreground"
                                >{challenges.length}</strong
                            > challenges</span
                        >
                    </div>
                    <div class="flex items-center gap-2">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            aria-hidden="true"
                        >
                            <path
                                d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"
                            ></path>
                        </svg>
                        <span
                            ><strong class="text-foreground"
                                >{allProviders.length}</strong
                            > cloud providers</span
                        >
                    </div>
                    <div class="flex items-center gap-2">
                        <svg
                            xmlns="http://www.w3.org/2000/svg"
                            width="16"
                            height="16"
                            viewBox="0 0 24 24"
                            fill="none"
                            stroke="currentColor"
                            stroke-width="2"
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            aria-hidden="true"
                        >
                            <rect
                                width="20"
                                height="14"
                                x="2"
                                y="7"
                                rx="2"
                                ry="2"></rect>
                            <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"
                            ></path>
                        </svg>
                        <span>Portfolio-ready projects</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filterable challenge list -->
        <ChallengeList
            client:load
            challenges={challenges}
            allProviders={allProviders}
            allServices={allServices}
            allTags={allTags}
            allLevels={allLevels}
        />
    </section>
</BaseLayout>
