---
import { getCollection, render } from "astro:content";
import type {
    ChallengeEntry,
    SolutionEntry,
    SolutionPath,
    SolutionDetailPageProps,
    ChallengeHeadings,
} from "@/lib/types";
import ChallengeLayout from "@/layouts/ChallengeLayout.astro";
import ComingSoon from "@/components/challenge/solution/ComingSoon.astro";
import MdxImage from "@/components/media/MdxImage.astro";

export async function getStaticPaths() {
    const challenges = await getCollection("challenges");
    const solutions = await getCollection("solutions");

    const paths: SolutionPath[] = challenges.map(
        (challenge: ChallengeEntry) => {
            // Find matching solution by challenge_uid
            const matchingSolution =
                solutions.find(
                    (sol: SolutionEntry) =>
                        sol.data.challenge_uid === challenge.data.uid,
                ) ?? null;

            return {
                params: { slug: challenge.id },
                props: { challenge, solution: matchingSolution },
            };
        },
    );

    return paths;
}

const { challenge, solution } = Astro.props as SolutionDetailPageProps;

const challengeUrl = `/challenge/${challenge.id}`;

// Solution content if available
let SolutionContent = null;
let headings: ChallengeHeadings = [];
if (solution) {
    const rendered = await render(solution);
    SolutionContent = rendered.Content;
    headings = rendered.headings ?? [];
}

const components = {
    img: MdxImage,
};
---

<ChallengeLayout entry={challenge} activeTab="solution" headings={headings}>
    {
        solution && SolutionContent ? (
            <SolutionContent components={components} />
        ) : (
            <ComingSoon challengeUrl={challengeUrl} />
        )
    }
</ChallengeLayout>
