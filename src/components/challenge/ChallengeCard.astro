---
import type { ChallengeEntry } from "@/lib/types";
import { Icon } from "astro-icon/components";
import {
    Card,
    CardHeader,
    CardTitle,
    CardDescription,
    CardContent,
    CardFooter,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";

const formatDuration = (hours: number) =>
    Number.isInteger(hours) ? `${hours}h` : `${hours.toFixed(1)}h`;

const props = Astro.props as { entry: ChallengeEntry };
const { entry } = props;

const levelLabel = entry.data.level
    ? `${entry.data.level[0].toUpperCase()}${entry.data.level.slice(1)}`
    : undefined;

const durationLabel =
    typeof entry.data.duration_hours === "number" &&
    entry.data.duration_hours > 0
        ? formatDuration(entry.data.duration_hours)
        : undefined;

const createdLabel = entry.data.created_at
    ? new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
      }).format(entry.data.created_at)
    : undefined;

const summaryText = entry.data.summary?.trim();
const highlightChips = [...entry.data.providers, ...entry.data.services];
const tagList = entry.data.tags ?? [];
---

<a
    href={`/challenge/${entry.id}`}
    class="group block"
    aria-label={`View challenge details for ${entry.data.title ?? entry.id}`}
>
    <Card
        className="h-full border-border/60 bg-card/80 shadow-md transition-all duration-300 hover:border-border hover:shadow-lg"
    >
        <CardHeader>
            <div class="flex items-start justify-between gap-4">
                <Badge
                    variant="secondary"
                    className="w-fit rounded-full px-3 py-1 text-[0.6rem] font-semibold uppercase tracking-[0.25em]"
                >
                    {levelLabel ?? "Challenge"}
                </Badge>
                {
                    durationLabel && (
                        <Badge
                            variant="outline"
                            className="rounded-full px-3 py-1 text-[0.65rem] font-semibold uppercase tracking-widest"
                        >
                            {durationLabel}
                        </Badge>
                    )
                }
            </div>
            <CardTitle
                className="mt-3 text-xl font-bold leading-snug tracking-tight transition-colors duration-200 group-hover:text-primary"
            >
                {entry.data.title ?? entry.id}
            </CardTitle>
            {
                createdLabel && (
                    <p class="text-xs text-muted-foreground">{createdLabel}</p>
                )
            }
        </CardHeader>

        {
            summaryText && (
                <CardContent className="pt-0">
                    <CardDescription className="line-clamp-2 text-sm leading-relaxed">
                        {summaryText}
                    </CardDescription>
                </CardContent>
            )
        }

        {
            highlightChips.length > 0 && (
                <CardContent className="pt-0">
                    <div class="flex flex-wrap gap-2">
                        {highlightChips.map((chip) => (
                            <Badge
                                variant="outline"
                                className="rounded-full px-2.5 py-0.5 text-[0.65rem] font-semibold uppercase tracking-widest"
                            >
                                {chip}
                            </Badge>
                        ))}
                    </div>
                </CardContent>
            )
        }

        {
            tagList.length > 0 && (
                <CardContent className="pt-0">
                    <div class="flex flex-wrap gap-2">
                        {tagList.map((tag) => (
                            <Badge
                                variant="secondary"
                                className="rounded-full px-2.5 py-0.5 text-[0.65rem] font-medium"
                            >
                                {tag}
                            </Badge>
                        ))}
                    </div>
                </CardContent>
            )
        }

        <CardFooter className="border-t border-border/50 pt-4">
            <span
                class="inline-flex items-center gap-1.5 text-xs font-medium text-muted-foreground transition-colors duration-200 group-hover:text-primary"
            >
                View challenge
                <Icon
                    name="arrow-right"
                    class="size-3.5 transition-transform duration-200 group-hover:translate-x-0.5"
                />
            </span>
        </CardFooter>
    </Card>
</a>
